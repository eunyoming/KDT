<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!-- JSTL 날짜 포맷 라이브러리 -->
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<!-- JQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- 부트스트랩 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous"></script>

<!-- css -->
<link rel="stylesheet" href="/resources/css/detail.css">

</head>

<body>
	<c:choose>
		<c:when test="${loginId == null}">
			<script>
				alert("로그인 후 이용해주세요.");
				location.href = "/";
			</script>
		</c:when>

		<c:otherwise>
			<!-- 로그인 했을 때 -->
			<div class="container">
				<!-- 컨텐츠 박스 ( 글 작성자 내용 ) -->
				<div class="contentsBox">
					<!-- 제목 -->
					<div class="row title">
						<div class="col" contenteditable="false" id="dto-title"
							name="dto-title">${dto.title }</div>
					</div>
					<!-- 작성자 -->
					<div class="row writer">
						<div class="col" id="dto_writer">
							<b>${dto.writer }</b>
						</div>
					</div>
					<!-- 날짜, 조회수 -->
					<div class="row date-view">
						<div class="col">
							<fmt:formatDate value="${dto.create_at}"
								pattern="yyyy-MM-dd HH:mm:ss" />
							| ${dto.view_count }
						</div>
					</div>
					<!-- 구분선 -->
					<hr>
					<!-- 글 내용 -->
					<div class="row contents">
						<div class="col" id="dto-contents" contenteditable="false"
							name="dto-contents">
							${dto.contents}
						</div>
					</div>
					<!-- 버튼들 -->
					<div class="row btns">
						<!-- 작성자 = 로그인한 사람 -->
						<c:if test="${loginId == dto.writer }">

							<div class="col btns text-end">
								<form id="delete-Frm" action="/delete.board" method="post">
									<button type="button" class="btn btn-dark d-none" id="noBtn">취소</button>
									<button type="button" class="btn btn-dark d-none" id="okBtn">수정완료</button>

									<button class="btn btn-dark" id="deleteBtn">삭제하기</button>
									<input type="hidden" value="${dto.seq}" name="dto_seq2"
										id="dto_seq2">

									<button type="button" class="btn btn-dark" id="updateBtn">수정하기</button>
									<button type="button" class="btn btn-dark" id="listBtn">목록으로</button>
								</form>
							</div>
						</c:if>
						<!-- 작성자 != 로그인한 사람 -->
						<c:if test="${loginId != dto.writer }">
							<div class="col btns text-end">
								<button type="button" class="btn btn-dark" id="listBtn">목록으로</button>
							</div>
						</c:if>
					</div>
					<!-- 글 내용 update form -->
					<form id="detail-Frm" action="/update.board" method="post">
						<input type="hidden" value="${dto.seq}" name="dto_seq"
							id="dto_seq"> <input type="hidden" value="${dto.title}"
							name="dto_title" id="dto_title"> <input type="hidden" 
							value="<c:out value='${dto.contents}'/>" name="dto_contents" id="dto_contents">
					</form>
				</div>


				<!-- 댓글 박스 -->
				<div class="row replies g-0">
					<!-- 댓글 div -->
					<div class="col replyDiv" contenteditable="true"></div>
					<!-- 댓글 등록 버튼 -->
					<div class="col-2 replyBtn">
						<button class="btn btn-outline-dark" id="replyBtn">등록</button>
					</div>
					<!-- 댓글 있을시 출력 -->
					<c:forEach var="replyDto" items="${list}">
						<div class="replyBlock">
							<div class="col-12 replyWriter">
								<b>${replyDto.writer}</b>
							</div>
							<div class="col-12 replyContentsDiv" contenteditable="false">${replyDto.contents}</div>
							<div class="col-12 replyWrite_date">
								<fmt:formatDate value="${replyDto.write_date}"
									pattern="yyyy-MM-dd HH:mm:ss" />
							</div>

							<c:if test="${loginId == replyDto.writer}">
								<form class="reply-Frm" action="" method="post">
									<div class="col-12 replyBtns">
										<button type="button"
											class="btn btn-outline-dark replyOkBtn d-none"
											data-reply-seq="${replyDto.seq}" data-parent-seq="${dto.seq}">수정완료</button>
										<button type="button"
											class="btn btn-outline-dark replyNoBtn d-none">취소</button>

										<button type="button"
											class="btn btn-outline-dark replyUpdateBtn">수정</button>
										<button class="btn btn-outline-dark replyDeleteBtn"
											data-reply-seq="${replyDto.seq}" data-parent-seq="${dto.seq}">삭제</button>

										<input type="hidden" class="reply_contents"
											value="${replyDto.contents}" name="reply_contents"> <input
											type="hidden" class="reply_seq" name="reply_seq"
											value="${replyDto.seq}"> <input type="hidden"
											class="parent_seq" name="parent_seq" value="${dto.seq}">
									</div>
								</form>

							</c:if>

							<hr id="replyHr">
						</div>
					</c:forEach>
				</div>

				<!-- 댓글 insert form -->
				<form id="reply-insert-Frm" action="/insert.reply" method="post">
					<input type="hidden" name="insert_reply_contents"
						id="insert_reply_contents"> <input type="hidden"
						name="insert_parent_seq" id="insert_parent_seq">
				</form>

			</div>

			<script>
				// 삭제버튼 클릭시
				$("#deleteBtn").on("submit", function() {
					let form = $("#delete-Frm");

					// 제목/내용은 필요 없으니 제거
					$("#dto_title").html("");
					$("#dto_writer").html("");

					form.submit();
				});

				// update 버튼 클릭시
				$("#updateBtn").on("click", function() {
					// 제목 영역을 수정 가능하게 변경
					$("#dto-title").attr("contenteditable", true);
					$("#dto-contents").attr("contenteditable", true);
					$("#dto-contents").focus();

					// 버튼들 생기게 하고, 숨기기
					$("#okBtn").removeClass("d-none");
					$("#noBtn").removeClass("d-none");
					$("#updateBtn").css("display", "none");
					$("#deleteBtn").css("display", "none");
				});

				// 목록으로 버튼 클릭시
				$("#listBtn").on("click", function() {
					// 목록으로 보내기
					window.location.href = "/board/list";
				});

				// 수정완료 버튼 클릭시
				$("#okBtn").on("click", function() {
					let form = $("#detail-Frm");
					form.attr("action", "/board/update");

					// 제목, 내용이 화면에 있는 경우 가져와서 넣기
					let title = $("#dto-title").html();
					let contents = $("#dto-contents").html();

					// hidden input에 값 넣기
					$("#dto_title").val(title);
					$("#dto_contents").val(contents);

					form.submit();
				});

				// 취소버튼 클릭시
				$("#noBtn").on(
						"click",
						function() {
							// 제목 영역을 수정 불가능하게 변경
							$("#dto-title").attr("contenteditable", false);
							$("#dto-contents").attr("contenteditable", false);

							// 다시 원래 페이지로 돌아가게 하기
							window.location.href = "/board/detail?seq="
									+ $("#dto_seq").val();
						});

				// 댓글 등록시
				$("#replyBtn").on("click", function() {
					$("#insert_reply_contents").val($(".replyDiv").html());
					$("#insert_parent_seq").val("${dto.seq}");
					$("#reply-insert-Frm").submit();
				});

				// 댓글 삭제버튼 클릭시
				$(".replyDeleteBtn").on("click", function() {

					let form = $(this).closest("form");

					// 버튼에 저장된 데이터 꺼내기
					//let reply_seq = $(this).data("reply-seq");
					//let parent_seq = $(this).data("parent-seq");

					// seq 담기
					form.find(".reply_seq").val();
					form.find(".parent_seq").val();

					// 내용은 필요 없으니 제거
					$(".reply_contents").html("");

					form.attr("action", "/reply/delete");
					form.submit();
				});

				// 댓글 수정버튼 클릭시
				$(".replyUpdateBtn").on(
						"click",
						function() {
							let form = $(this).closest("form");

							// 버튼 생기게 하고 없애기
							form.find(".replyOkBtn").removeClass("d-none");
							form.find(".replyNoBtn").removeClass("d-none");
							form.find(".replyUpdateBtn").addClass("d-none");
							form.find(".replyDeleteBtn").addClass("d-none");

							$(this).closest(".replyBlock").find(
									".replyContentsDiv").attr(
									"contenteditable", true).focus();
						});
				// 댓글 취소버튼 클릭시
				$(".replyNoBtn").on(
						"click",
						function() {
							let form = $(this).closest("form");

							// contents 내용 다시 옮겨 담기
							let replyContentsDiv = $(this).closest(
									".replyBlock").find(".replyContentsDiv");
							replyContentsDiv.html(form.find(".reply_contents")
									.val());

							// 버튼 생기게 하고 없애기
							form.find(".replyOkBtn").addClass("d-none");
							form.find(".replyNoBtn").addClass("d-none");
							form.find(".replyUpdateBtn").removeClass("d-none");
							form.find(".replyDeleteBtn").removeClass("d-none");

							// Div 수정 못하게 막기
							replyContentsDiv.attr("contenteditable", false);
						});

				// 댓글 수정완료 버튼 클릭시
				$(".replyOkBtn").on(
						"click",
						function() {
							// 버튼 기준 form, 댓글 입력한 div 찾기
							let form = $(this).closest("form");
							let replyContentsDiv = $(this).closest(
									".replyBlock").find(".replyContentsDiv");

							// 버튼에 저장된 데이터 꺼내기
							let reply_seq = $(this).data("reply-seq");
							let parent_seq = $(this).data("parent-seq");

							// input hidden 에 옮겨 담기
							form.find(".reply_contents").val(
									replyContentsDiv.html());
							form.find(".reply_seq").val(reply_seq);
							form.find(".parent_seq").val(parent_seq);

							// 버튼 생기게 하고 없애기
							form.find(".replyOkBtn").addClass("d-none");
							form.find(".replyNoBtn").addClass("d-none");
							form.find(".replyUpdateBtn").removeClass("d-none");
							form.find(".replyDeleteBtn").removeClass("d-none");
							$(this).closest(".replyBlock").find(
									".replyContentsDiv").attr(
									"contenteditable", false);

							// form action 추가하고 보내기
							form.attr("action", "/reply/update");
							form.submit();
						});
			</script>

		</c:otherwise>
	</c:choose>
</body>

</html>