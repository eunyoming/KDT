package com.kedu.controllers;

import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import com.kedu.commons.CustomEncrypt;
import com.kedu.dao.MembersDAO;
import com.kedu.dto.MembersDTO;

@Controller
@RequestMapping("/members")
public class MembersController {

	@Autowired
	MembersDAO dao;
	
	@RequestMapping("/join")
	public String toJoin() {
		return "members/joinform";
	}
	
	@RequestMapping(value = "/insert", method = RequestMethod.POST)
	public String insert(MembersDTO dto, HttpSession session) throws Exception{	
		// 비밀번호 암호화
		dto.setPw(CustomEncrypt.encrypt(dto.getPw()));
		
		dao.insert(dto);
		
		// 세션에 id 저장
		session.setAttribute("loginId", dto.getId());

		return "redirect:/";
	}
	
	@RequestMapping(value = "/delete", method = RequestMethod.POST)
	public String deleteById(HttpSession session) throws Exception{
		String loginId = (String)session.getAttribute("loginId");
		dao.deleteById(loginId);

		return "redirect:/";
	}
	
	// 마이페이지 이동
	@RequestMapping("/mypage")
	public String getMemberById(HttpSession session, Model m) throws Exception{
		String loginId = (String)session.getAttribute("loginId");
		
		MembersDTO dto = dao.getMemberById(loginId);
		m.addAttribute(dto);
		
		return "members/mypage";
	}
	
	// 수정 페이지로 이동
	@RequestMapping("/mypage_update")
	public String updatePage() {
		return "members/mypage_update";
	}
	
	// 수정하기 눌렀을 때
	@RequestMapping("/update")
	public String updateById(MembersDTO dto) throws Exception{

		dao.updateById(dto);

		return "redirect:/members/mypage";
	}



	@ExceptionHandler(Exception.class) // 예외계 Object 같은 느낌 모든 예외의 조상
	public String exceptionHandler(Exception e) {
		e.printStackTrace();
		return "redirect:/error";
	}
}
